# ブラフゲームアプリ仕様書

## 1. プロジェクト概要
本ドキュメントは、2〜6人で遊ぶブラフ系ボードゲームのモバイルアプリ開発用仕様書である。
AI駆動開発において、明確なロジックと状態遷移を定義することを目的とする。

### ターゲットプラットフォーム
- iOS / Android (クロスプラットフォーム開発を想定)
- **技術スタック**: React Native (Expo) + TypeScript + React Context API
  - Expo を使用したクロスプラットフォーム開発
  - TypeScript による型安全性の確保
  - 状態管理には **React Context API** と **useReducer** を使用する
  - アニメーションには **react-native-reanimated** を活用する
  - **バックエンド**: Firebase (Authentication, Firestore, Cloud Functions)
- **画面の向き**: **縦画面 (Portrait)** 固定。片手操作と手札の秘匿性を重視。

### 基本コンセプト
- **デジタル・サブスティテュート**: 物理的なカードがない時の代用品としての利用を想定。
- **対面プレイ前提**: プレイヤーは同じ場所に集まって遊ぶ。会話や表情の読み合いはリアルで行う。
- **オンラインマルチプレイ**: Firebaseを使用したリアルタイム通信によるルーム対戦機能。
- **多言語対応**: 日本語と英語の切り替えに対応。

---

## 2. 用語定義

本仕様書で使用する用語を以下に定義する。

| 用語 | 英語表記 | 定義 |
|------|----------|------|
| **入札開始** | Bid Start | 手番フェーズを終了し、入札フェーズを開始する行為。最初の枚数宣言を含む。 |
| **入札** | Bid | 天使の枚数を宣言すること。 |
| **レイズ** | Raise | 現在の最高宣言枚数より多い数を宣言すること。 |
| **パス** | Pass | 入札から降りること。 |
| **最高入札者** | Highest Bidder | 入札フェーズで最終的に最も高い枚数を宣言し、判定を行うプレイヤー。 |
| **判定** | Resolution | 最高入札者がカードをめくり、成功/失敗を決定する処理。 |
| **場** | Stack / Play Area | プレイヤーが裏向きでカードを積み上げる領域。 |
| **手札** | Hand | プレイヤーが手元に持っている、他プレイヤーから見えないカード。 |
| **脱落** | Eliminated | カードが0枚になり、ゲームから除外された状態。観戦モードに移行する。 |

---

## 3. ゲームルール詳細

### 3.1 基本情報
- **プレイ人数**: 2〜6人
- **コンポーネント**:
  - 各プレイヤー: **カード**4枚（天使 3枚、死神 1枚）
  - **カードデザイン**: 以下の6種類のテーマカラーを用意し、プレイヤーごとに割り当てる。
    - **カラー**: 青、赤、黄、緑、紫、ピンク
    - **裏面**: 各テーマカラーを基調としたデザイン。
    - **表面**: 各テーマカラーの世界観に合わせた「天使」と「死神」のイラスト。

### 3.2 勝利条件
以下のいずれかを満たしたプレイヤーが勝利する。
1. **判定成功**: 2回成功させる。
2. **サバイバー**: 他の全員が脱落し、自分だけがカードを持っている状態になる。

### 3.3 ゲームの流れ (ラウンド進行)
ラウンドは以下のフェーズで進行する。

#### A. ラウンド準備フェーズ (Round Setup Phase)
各ラウンド開始時に実行される。
1. 前ラウンドで場に出たカードを全て手札に戻す（除外されたカードは戻らない）。
2. 生存している全プレイヤーは手札から1枚を選び、自分の場に**裏向き**でセットする。
3. カードを置いた後、**「準備完了」ボタン**を押す（置き直し可能）。
4. 全員が準備完了したら、先手プレイヤーから手番フェーズを開始する。

#### B. 手番フェーズ (Placement Phase)
先手プレイヤーから時計回りに手番を行う。手番プレイヤーは以下のいずれかを選択する。

**手番順序**: 脱落したプレイヤーはスキップされる。

1. **カードの追加**:
   - 手札がある場合のみ選択可能。
   - 手札から1枚選び、自分の場のカードの上に裏向きで重ねる。
   - **確認不可**: 一度場に出したカードの内容（天使か死神か）は、自分でも確認できない。
   - **カード配置後の操作**:
     - カードを配置すると「確定して次へ」ボタンが表示される（入札ボタンは非表示）。
     - **プレイマットをタップ**: 配置したカードを手札に戻してやり直し可能。
     - **確定ボタンを押す**: 配置を確定し、手番は次のプレイヤーへ移る。
2. **入札開始 (Bid Start)**:
   - 自分の場に少なくとも1枚カードがある場合に選択可能。
   - **先手プレイヤーも、2枚目を置かずに即座に入札開始可能**。
   - **手札がない場合**: カードの追加はできず、**必ず入札開始**しなければならない。
   - **宣言枚数の制限**:
     - **下限**: 1枚（0枚は不可）。
     - **上限**: 場にある全プレイヤーのカード総数。
   - これ以降、カードの追加は不可となり、**入札フェーズ**へ移行する。

#### C. 入札フェーズ (Bidding Phase)
入札開始者の左隣のプレイヤーから順に、以下のいずれかを行う。

**手番順序**: 脱落したプレイヤーおよびパス済みのプレイヤーはスキップされる。

1. **レイズ (Raise)**:
   - 現在の最高宣言枚数より多い数を宣言する。
   - 最大数は「場に出ている全カード枚数」。
2. **パス (Pass)**:
   - 入札から降りる。以降、このラウンドでは入札に参加できない。

- **宣言上限に到達した場合の即時遷移**:
  - 入札枚数が「場の全カード枚数」と同じ（最大値）になった瞬間、他プレイヤーのレイズ/パスを待たずに**即座に判定フェーズへ進む**。
- それ以外の場合は、最高枚数を宣言したプレイヤー以外全員がパスするまで続ける。
- 残った1人が**最高入札者**となり、判定フェーズへ進む。

#### D. 判定フェーズ (Resolution Phase)
最高入札者は宣言した枚数分のカードを**1枚ずつ**めくる。

**フェーズ開始タイミング**:
- 入札上限（場の全カード枚数）に到達した場合は、直前のプレイヤーが宣言した瞬間に判定フェーズへ即時移行する。

1. **自分のカードからめくる**:
   - まず、自分の場のカードからめくらなければならない。
   - **自分の場の枚数が宣言枚数より多い場合**: 上から順に**必要な枚数（宣言枚数）だけ**めくる。
   - **自分の場の枚数が宣言枚数以下の場合**: 自分のカードを**全て**めくり、不足分を他プレイヤーからめくる。
2. **他プレイヤーのカードをめくる**:
   - 自分のカードを全てめくり終え、かつ宣言枚数に達していない場合、他プレイヤーの山を選んで上から1枚ずつめくる。
   - どのプレイヤーの山をめくるかは最高入札者が**都度選択**できる。
   - **選択UI**: 他プレイヤーの場（プレイマット）をタップして選択する。
   - **演出**: カードをめくる際、フリップアニメーションと共に結果が表示される。

**結果判定**:
- **成功**: 宣言枚数分すべてが「天使」だった場合。
  - 成功回数カウントを+1する。
  - 2回成功でゲーム勝利。
  - **ポップアップ**: 全プレイヤーの画面に「判定成功！」のポップアップを表示（タップで非表示）。
- **失敗**: 途中で「死神」が出た場合。
  - 即座にめくるのを中断。
  - ペナルティフェーズへ移行する。
  - **ポップアップ**: 全プレイヤーの画面に「判定失敗！」のポップアップを表示（タップで非表示）。

#### E. ペナルティフェーズ (Penalty Phase)
判定失敗時、最高入札者はカードを1枚失う。

1. **自分の死神で失敗した場合**:
   - 最高入札者は**手持ちカードから任意で1枚選び**、ゲームから除外する。
   - **UI処理**: 選択画面では**全てのカードが表向き**で表示され、何を捨てるか確認できる。
2. **他人の死神で失敗した場合**:
   - **UI処理**: 最高入札者の手持ちカードが、死神を出していたプレイヤーの画面に**裏向きで表示**される。
   - 死神を出していたプレイヤーがその中から**1枚選び**、ゲームから除外する。
   - **非公開**: 除外されたカードの種類は、**他のプレイヤーには公開されない**。

**脱落判定**:
- **カードが0枚になった場合**: そのプレイヤーは**失格（脱落）**となる。
- **脱落時の処理**:
  - 脱落プレイヤーの場に残っているカードは**即座にゲームから除外**される。
  - 脱落プレイヤーは**観戦モード**に移行する。

#### F. ラウンド終了フェーズ (Round End Phase)
1. **勝利判定**: いずれかのプレイヤーが勝利条件を満たしているか確認。
2. **次ラウンドの先手プレイヤー決定**:
   - **最高入札者が生存**: 最高入札者が先手。
   - **最高入札者が脱落（他人の死神）**: **死神を出していたプレイヤー**が先手。
   - **最高入札者が脱落（自分の死神）**: **脱落した最高入札者が指名したプレイヤー**が先手。
3. ラウンド準備フェーズへ戻る（オンラインモードでは自動遷移）。

---

## 4. アプリ機能要件

### 4.1 全体共通機能
- **多言語対応**:
  - **言語**: 日本語、英語
  - **設定方法**: ホーム画面で国旗アイコン（🇯🇵/🇺🇸）を選択。
  - **保存**: 選択した言語設定は永続化される。
- **アプリアイコン**: 指定されたアイコン画像を設定済み。

### 4.2 テストモード（実装済み）
- **ローカル実行**: ネットワーク接続なしで動作。
- **プレイヤー切り替え**: 1台の端末で全プレイヤーを操作。
- **目的**: ルール確認やUIテスト用。

### 4.3 オンライン対戦機能（実装済み）

#### 4.3.1 アーキテクチャ
- **バックエンド**: Firebase (Firestore, Cloud Functions)
- **認証**: 匿名認証 (Anonymous Auth)
- **ロジック**: ゲームの主要ロジックは Cloud Functions で実行し、不正を防ぐ。

#### 4.3.2 ルーム機能
- **ルーム作成**:
  - 最大6人まで参加可能。
  - 4桁の合言葉（数字・アルファベット）を生成。
- **ルーム参加**:
  - 合言葉を入力して参加。
- **待機所 (Lobby)**:
  - 参加者一覧、準備完了状態を表示。
  - ホストは最低2人以上でゲーム開始可能。
  - **ゲーム開始時の人数**: 開始時点での参加人数でゲームがスタートする。

#### 4.3.3 ゲームプレイ
- **リアルタイム同期**: Firestoreのリスナーで状態を同期。
- **アクション送信**: クライアントからCloud Functionsを呼び出し、サーバー側で状態更新。
- **ハートビート**: 接続状態を監視し、切断を検知。
- **自動進行**: ラウンド終了後、自動的に次のラウンド準備へ遷移。

#### 4.3.4 ゲーム終了・再戦
- **結果画面**: 勝者を表示。
- **Play Again**:
  - オンライン対戦終了後、「Play Again」ボタンを押すと**ロビー（待機所）に戻る**。
  - 参加者は全員そのまま残り、準備未完了状態で再開。
  - ホストは再度ゲーム開始可能。

### 4.4 UI/UX詳細

#### 4.4.1 フェーズ遷移
- **ポップアップ**: フェーズが変わる際、画面全体にフェーズ名を表示するモーダルが出現。
- **操作**: 画面タップで即座に非表示可能（または数秒で自動消去）。

#### 4.4.2 判定結果表示
- **ポップアップ**: 判定の成功/失敗時に、結果を示すモーダルを表示。
  - **成功**: 天使アイコンと成功メッセージ。
  - **失敗**: ドクロアイコンと失敗メッセージ（誰の死神だったかも表示）。
- **操作**: 画面タップで非表示可能。

#### 4.4.3 カード操作
- **プレイマット**:
  - 自分のターン中、プレイマットをタップすることで、直前に置いたカードを手札に戻せる（入札開始前のみ）。
- **アニメーション**:
  - カードをめくる際のアニメーション。
  - 判定時、対象プレイヤーのプレイマットを強調表示（パルスアニメーション）。

---

## 5. データモデル (Firestore)

### 5.1 Collections
- **users**: ユーザー情報（ニックネーム等）
- **rooms**: ルーム情報（ステータス、参加者IDリスト）
- **rooms/{roomId}/players**: ルーム内プレイヤー情報（準備状態、接続状態）
- **gameStates**: ゲーム進行状態（フェーズ、手札、場札、入札状況）
- **gameStates/{roomId}/logs**: ゲームログ（アクション履歴）
- **gameActions**: クライアントから送信されたアクションキュー

### 5.2 セキュリティ
- **Firestore Rules**: 参加者のみが読み取り可能、書き込みはCloud Functions経由に限定（一部例外あり）。
- **Cloud Functions**: ゲームロジックのバリデーションと状態更新を担当。

---

## 6. 今後の課題・拡張予定
- **観戦機能**: 脱落後の観戦モードの完全実装。
- **切断時のCPU代行**: 完全に実装し、スムーズなゲーム進行を保証する。
- **広告実装**: 本番環境での広告ID設定と表示フローの調整。
- **サウンド**: 効果音・BGMの追加。

