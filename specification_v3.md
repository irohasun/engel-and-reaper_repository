# ブラフゲームアプリ仕様書

## 1. プロジェクト概要
本ドキュメントは、2〜6人で遊ぶブラフ系ボードゲームのモバイルアプリ開発用仕様書である。
AI駆動開発において、明確なロジックと状態遷移を定義することを目的とする。

### ターゲットプラットフォーム
- iOS / Android (クロスプラットフォーム開発を想定)
- **技術スタック**: React Native (Expo) + TypeScript + React Context API
  - Expo を使用したクロスプラットフォーム開発
  - TypeScript による型安全性の確保
  - 状態管理には **React Context API** と **useReducer** を使用する
  - アニメーションには **react-native-reanimated** を活用する
- **画面の向き**: **縦画面 (Portrait)** 固定。片手操作と手札の秘匿性を重視。

### 基本コンセプト
- **デジタル・サブスティテュート**: 物理的なカードがない時の代用品としての利用を想定。
- **対面プレイ前提**: プレイヤーは同じ場所に集まって遊ぶ。会話や表情の読み合いはリアルで行う。
- **テストモード**: 現在はローカルでのテストモードを実装。1台の端末で全プレイヤーを操作可能。
- **将来の拡張**: オンラインマルチプレイ機能（ルーム作成・入室・リアルタイム同期）は将来実装予定。

---

## 2. 用語定義

本仕様書で使用する用語を以下に定義する。

| 用語 | 英語表記 | 定義 |
|------|----------|------|
| **入札開始** | Bid Start | 手番フェーズを終了し、入札フェーズを開始する行為。最初の枚数宣言を含む。 |
| **入札** | Bid | 天使の枚数を宣言すること。 |
| **レイズ** | Raise | 現在の最高宣言枚数より多い数を宣言すること。 |
| **パス** | Pass | 入札から降りること。 |
| **最高入札者** | Highest Bidder | 入札フェーズで最終的に最も高い枚数を宣言し、判定を行うプレイヤー。 |
| **判定** | Resolution | 最高入札者がカードをめくり、成功/失敗を決定する処理。 |
| **場** | Stack / Play Area | プレイヤーが裏向きでカードを積み上げる領域。 |
| **手札** | Hand | プレイヤーが手元に持っている、他プレイヤーから見えないカード。 |
| **脱落** | Eliminated | カードが0枚になり、ゲームから除外された状態。観戦モードに移行する。 |

---

## 3. ゲームルール詳細

### 3.1 基本情報
- **プレイ人数**: 2〜6人
- **コンポーネント**:
  - 各プレイヤー: **カード**4枚（天使 3枚、死神 1枚）
  - **カードデザイン**: 以下の6種類のテーマカラーを用意し、プレイヤーごとに割り当てる。
    - **カラー**: 青、赤、黄、緑、紫、ピンク
    - **裏面**: 各テーマカラーを基調としたデザイン。
    - **表面**: 各テーマカラーの世界観に合わせた「天使」と「死神」のイラスト。

### 3.2 勝利条件
以下のいずれかを満たしたプレイヤーが勝利する。
1. **判定成功**: 2回成功させる。
2. **サバイバー**: 他の全員が脱落し、自分だけがカードを持っている状態になる。

### 3.3 ゲームの流れ (ラウンド進行)
ラウンドは以下のフェーズで進行する。各フェーズでの行動と遷移条件のみを簡潔に示す。

#### A. ラウンド準備フェーズ (Round Setup Phase)
各ラウンド開始時に実行される。
1. 前ラウンドで場に出たカードを全て手札に戻す（除外されたカードは戻らない）。
2. 生存している全プレイヤーは手札から1枚を選び、自分の場に**裏向き**でセットする。
3. カードを置いた後、**「準備完了」ボタン**を押す（置き直し可能）。
4. 全員が準備完了したら、先手プレイヤーから手番フェーズを開始する。

#### B. 手番フェーズ (Placement Phase)
先手プレイヤーから時計回りに手番を行う。手番プレイヤーは以下のいずれかを選択する。

**手番順序**: 脱落したプレイヤーはスキップされる。

1. **カードの追加**:
   - 手札がある場合のみ選択可能。
   - 手札から1枚選び、自分の場のカードの上に裏向きで重ねる。
   - **確認不可**: 一度場に出したカードの内容（天使か死神か）は、自分でも確認できない（記憶頼み）。
   - **カード配置後の操作**:
     - カードを配置すると「Ready」ボタンが表示される。
     - **プレイマットをタップ**: 配置したカードを手札に戻してやり直し可能。
     - **Readyボタンを押す**: 配置を確定し、手番は次のプレイヤーへ移る。
2. **入札開始 (Bid Start)**:
   - 自分の場に少なくとも1枚カードがある場合に選択可能。
   - **先手プレイヤーも、2枚目を置かずに即座に入札開始可能**。
   - **手札がない場合**: カードの追加はできず、**必ず入札開始**しなければならない。
   - **宣言枚数の制限**:
     - **下限**: 1枚（0枚は不可）。
     - **上限**: 場にある全プレイヤーのカード総数（いきなり最大数を宣言することも可能）。
   - これ以降、カードの追加は不可となり、**入札フェーズ**へ移行する。

#### C. 入札フェーズ (Bidding Phase)
入札開始者の左隣のプレイヤーから順に、以下のいずれかを行う。

**手番順序**: 脱落したプレイヤーおよびパス済みのプレイヤーはスキップされる。

1. **レイズ (Raise)**:
   - 現在の最高宣言枚数より多い数を宣言する。
   - 最大数は「場に出ている全カード枚数」。
2. **パス (Pass)**:
   - 入札から降りる。以降、このラウンドでは入札に参加できない。

- **宣言上限に到達した場合の即時遷移**:
  - 入札枚数が「場の全カード枚数」と同じ（最大値）になった瞬間、他プレイヤーのレイズ/パスを待たずに**即座に判定フェーズへ進む**。
- それ以外の場合は、最高枚数を宣言したプレイヤー以外全員がパスするまで続ける。
- 残った1人が**最高入札者**となり、判定フェーズへ進む。

#### D. 判定フェーズ (Resolution Phase)
最高入札者は宣言した枚数分のカードを**1枚ずつ**めくる。

**フェーズ開始タイミング**:
- 入札上限（場の全カード枚数）に到達した場合は、直前のプレイヤーが宣言した瞬間に判定フェーズへ即時移行する（レイズ/パス待ちをスキップ）。

1. **自分のカードからめくる**:
   - まず、自分の場のカードからめくらなければならない。
   - **自分の場の枚数が宣言枚数より多い場合**: 上から順に**必要な枚数（宣言枚数）だけ**めくる。
   - **自分の場の枚数が宣言枚数以下の場合**: 自分のカードを**全て**めくり、不足分を他プレイヤーからめくる。
2. **他プレイヤーのカードをめくる**:
   - 自分のカードを全てめくり終え、かつ宣言枚数に達していない場合、他プレイヤーの山を選んで上から1枚ずつめくる。
   - どのプレイヤーの山をめくるかは最高入札者が**都度選択**できる。
   - **選択UI**: 他プレイヤーの場（プレイマット）をタップして選択する。

**結果判定**:
- **成功**: 宣言枚数分すべてが「天使」だった場合。
  - 成功回数カウントを+1する。
  - 2回成功でゲーム勝利。
- **失敗**: 途中で「死神」が出た場合。
  - 即座にめくるのを中断。
  - ペナルティフェーズへ移行する。

#### E. ペナルティフェーズ (Penalty Phase)
判定失敗時、最高入札者はカードを1枚失う。

1. **自分の死神で失敗した場合**:
   - 自分の死神をめくって失敗した場合でも、めくった死神カード自体は即座に除外されない。
   - 最高入札者は**手持ちカードから任意で1枚選び**、ゲームから除外する。
   - どのカードを除外するかは自由選択（任意の手札）。
   - **UI処理**: 選択画面では**全てのカードが表向き**で表示され、何を捨てるか確認できる。
2. **他人の死神で失敗した場合**:
   - **UI処理**: 最高入札者の手持ちカードが、死神を出していたプレイヤーの画面に**裏向きで表示**される。
   - 死神を出していたプレイヤーがその中から**1枚選び**、ゲームから除外する（ランダム選択でも可）。
   - めくられた死神カード自体は即座に除外されない。除外されるのは相手が選んだ1枚のみ。
   - **非公開**: 除外されたカードの種類（天使/死神）は、**他のプレイヤーには公開されない**（ログにも出さない）。

**ペナルティカード選択UI**:
- カードを選択すると**拡大表示**される（選択状態を示す）。
- 「**Confirm**」ボタンを押すことで除外が確定する。
- 同じカードを再度タップすると選択解除可能。

**脱落判定**:
- **カードが0枚になった場合**: そのプレイヤーは**失格（脱落）**となる。
- **脱落時の処理**:
  - 脱落プレイヤーの場に残っているカードは**即座にゲームから除外**される。
  - 脱落プレイヤーは**観戦モード**に移行し、ゲームの様子を見ることができる。

#### F. ラウンド終了フェーズ (Round End Phase)
1. **勝利判定**: いずれかのプレイヤーが勝利条件を満たしているか確認。
2. **次ラウンドの先手プレイヤー決定**:
   - **最高入札者が生存**: 最高入札者が先手。
   - **最高入札者が脱落（他人の死神）**: **死神を出していたプレイヤー**が先手。
   - **最高入札者が脱落（自分の死神）**: **脱落した最高入札者が指名したプレイヤー**が先手。
3. ラウンド準備フェーズへ戻る。

---

## 4. アプリ機能要件

### 4.1 テストモード（現在実装済み）
- **ローカル実行**: Firebase/Supabaseに接続せず、端末内のみでゲームを完結させる。
- **状態管理**: React Context API + useReducer を使用し、ローカル状態でゲームを管理する。
- **プレイヤー切り替え機能**:
  - テストモードでは、全プレイヤーの操作を1台の端末から行える。
  - **UI**: 画面上部に「プレイヤー切り替え」セレクターを配置。
  - **挙動**: 切り替えると、選択したプレイヤー視点のUIに遷移する（手札、プレイマット等が切り替わる）。
  - **手番表示**: 現在の手番プレイヤーを明確に表示し、誰を操作すべきか分かりやすくする。
- **仮想プレイヤー**: 2〜6人の仮想プレイヤーを作成し、それぞれに名前とテーマカラーを割り当てる。

### 4.2 ユーザー管理（将来の拡張）
- **匿名ログイン**: アプリ起動時にUUID等を生成し、ユーザーIDとする。
- **ニックネーム**: ユーザーは任意の表示名を設定可能。

### 4.3 ルーム管理（将来の拡張）
- **ルーム作成**:
  - ホストがルームを作成。
  - 4〜6桁の「合言葉（Room Code）」を発行。
- **ルーム入室**:
  - ゲストは合言葉を入力して入室。
- **待機所 (Lobby)**:
  - 参加者一覧表示。
  - ホストが「ゲーム開始」ボタンを押すとゲーム開始。
- **ルームの有効期限**:
### 4.4 ゲーム画面 UI/UX

#### 4.4.1 画面レイアウト (縦画面)

**中央エリア (プレイマット)**:
- 画面中央に自分のプレイマットを大きく配置。
- ここにカードをドラッグして重ねていく。
- **場のカード枚数表示**:
  - カードを少しずつずらして重ね、枚数が視覚的に分かるようにする。
  - カードの下部に枚数を数値で表示する。
- **リーチ状態の表示**:
  - 0勝時: プレイマットの裏地は**黒**。
  - 1勝時（リーチ）: プレイマットが裏返され、**各テーマカラーに沿った色**になる。

**画面端エリア (他プレイヤー情報)**:
- 画面の上部・左右の端に、他プレイヤーのプレイマット（小サイズ）を配置。
- **表示情報**:
  - **プレイマットの色**: 0勝は黒、1勝はテーマカラー（リーチ状態が一目で分かる）。
  - **場のカード枚数**: 重なり具合と数値で表示。
  - **宣言状況**: 入札フェーズ中、吹き出しで「3枚」や「パス」を表示。
  - **手札枚数**: 裏向きのカードアイコンで残枚数を表示。
  - **パス状態**: パス済みのプレイヤーは視覚的にグレーアウトまたはマーク表示。

**自分の手札エリア (画面下部)**:
- **扇形配置**: カードゲーム（例: 遊戯王）のように、手札4枚を扇状に展開して表示する。
- **インタラクション**:
  - **ドラッグ/長押し**: 指で触れると対象のカードが少し浮き上がる（フォーカス表示）。
  - **スワイプ操作**: 前方（画面上方向）へスワイプすることでプレイマットにカードを出す。
    - **スワイプ判定**: 一定距離（例: 画面高さの15%）以上のスワイプで発動。
    - **視覚フィードバック**: スワイプ中はカードがドラッグに追従し、閾値を超えるとハイライト表示。
    - **キャンセル**: 閾値未満で指を離すとカードが元の位置に戻る。
- **アニメーション**: スワイプして場に出る際、**空中で裏面にひっくり返りながら**プレイマットに置かれるリアルな挙動を実装する。

#### 4.4.2 判定フェーズのUI
- **カードめくり**: 1枚ずつめくる。めくるアニメーションを実装。
- **他プレイヤー選択**: 他プレイヤーの場（プレイマット）をタップして、めくる対象を選択。
- **選択可能表示**: めくれる対象のプレイマットをハイライト表示。

#### 4.4.3 ゲーム終了画面
- **勝者発表演出**:
  - 勝者のプレイヤー名が画面中央にアップで表示される。
  - クラッカーが発射されるハッピーな演出。
- **再戦機能**:
  - 「もう一度遊ぶ」ボタンを表示。
  - ボタン押下時に**広告を表示**（Google AdMob インタースティシャル広告）。
  - 広告終了後、同じメンバーで待機所に戻り、再戦可能。

#### 4.4.4 観戦モード
- 脱落したプレイヤーは観戦モードに移行。
- ゲームの進行状況をリアルタイムで閲覧できる。
- 操作は不可（UIはグレーアウトまたは非表示）。
- **表示内容**: 全プレイヤーの場のカード枚数、入札状況、判定結果。
- **非表示**: 各プレイヤーの手札内容（秘匿情報）。

#### 4.4.5 フェーズ遷移ポップアップ
- 各フェーズ移行時に、画面全体を覆う半透明のポップアップを約2秒表示し、現在フェーズを告知する。
- 表示例: 「ラウンド準備へ」「入札フェーズへ」「判定フェーズへ」など。
- 表示後はフェードアウトし、自動的に消える（ユーザー操作不要）。

### 4.5 デザインアセット
- **テーマ**: 大航海時代の酒場でのギャンブル (Age of Discovery, Tavern Gambling)。
- **カード裏面**: 6色のテーマカラー（青、赤、黄、緑、紫、ピンク）ごとに異なる。古びた羊皮紙や革のテクスチャに、羅針盤や航海図をモチーフにした金色の幾何学模様。
- **カード正面**: 天使、死神のデザイン。
  - **天使**: 神聖な雰囲気のデザイン。光輪を持つ天使のシルエットが描かれている。
  - **死神**: 禍々しい雰囲気のデザイン。鎌を持つ死神のシルエットが描かれている。
- **プレイマット**: 酒場の木のテーブルに敷かれた、ワインのシミがついたベルベットの円形マット。端には金糸で海図のような刺繍。

### 4.6 履歴/ログ
ゲーム中のアクションをログとして画面に表示する。

**ログの種類**:
| type | 説明 | 表示例 |
|------|------|--------|
| `place_card` | カード追加 | 「Aliceがカードを追加しました」 |
| `bid_start` | 入札開始 | 「Bobが3枚で入札を開始しました」 |
| `raise` | レイズ | 「Carolが5枚に上げました」 |
| `pass` | パス | 「Daveがパスしました」 |
| `reveal` | カードめくり | 「Bobがカードをめくりました」 |
| `resolution_success` | 判定成功 | 「Bobが判定成功！」 |
| `resolution_fail` | 判定失敗 | 「Bobが判定失敗...」 |
| `eliminate` | プレイヤー脱落 | 「Daveが脱落しました」 |
| `game_end` | ゲーム終了 | 「Aliceの勝利！」 |

**保存件数**: 直近100件まで保存。古いログは削除される。

### 4.7 リアルタイム通信・同期技術要件（将来の拡張）
- **同期方式**: Supabase Realtime または Firestoreのリアルタイムリスナーを使用し、サーバー上の状態変更を即座に全クライアントに反映する。
- **排他制御 (Concurrency Control)**:
  - 同時操作（例: ほぼ同時に複数人が入札ボタンを押すなど）による不整合を防ぐため、ゲーム進行に関わる全てのアクションは **Transaction** を用いて実行する。
  - トランザクション内で「現在のフェーズ」や「手番プレイヤー」を厳密にチェックし、整合性が取れない場合は処理を拒否（ロールバック）する。
- **遅延対策**:
  - 厳密な状態管理が必要なため、ローカルでの楽観的UI更新 (Optimistic UI) は**行わない**。
  - アクション実行時はローディング表示を行い、サーバーからの完了通知（Realtime更新）を待って画面を遷移させることで、全員が常に同じ状態を見ることを保証する。

### 4.8 接続断・復帰処理（将来の拡張）

#### 4.8.1 プレイヤー切断時の挙動
- **タイムアウト**: 30秒間操作がない場合、切断と判定。
- **CPU代行**: 切断プレイヤーの手番はランダムでCPUがプレイする。
  - **手番フェーズ**: ランダムでカード追加または入札開始。
  - **入札フェーズ**: ランダムでレイズまたはパス。
  - **判定フェーズ**: ランダムでカードをめくる対象を選択。
  - **ペナルティフェーズ**: ランダムでカードを選択。
- **復帰**: 切断プレイヤーが復帰した場合、即座に操作権限が戻る。

#### 4.8.2 ホスト切断時の挙動
- **待機所（Lobby）**: ホストが30秒以上切断した場合、参加順で次のプレイヤーにホスト権限を自動移譲。
- **ゲーム中**: ホストもCPU代行（ゲーム中はホスト権限不要のため）。

#### 4.8.3 アプリ復帰
- アプリがクラッシュしたりバックグラウンドに移行しても、再起動してルームに入り直せば、データベースから最新の状態を取得して即座にゲームに復帰できる設計とする。

---

## 5. データモデル

### 5.1 ローカル状態管理（現在実装済み）

現在の実装では、React Context API + useReducer を使用してローカル状態でゲームを管理している。

#### 5.1.1 GameState 型定義

```typescript
interface GameState {
  phase: GamePhase;                    // 現在のフェーズ
  currentRound: number;                 // 現在のラウンド数
  players: Player[];                    // プレイヤー配列
  playerOrder: string[];               // プレイヤーの順序
  turnPlayerId: string | null;         // 現在の手番プレイヤーID
  bidAmount: number;                    // 現在の入札額
  highestBidderId: string | null;       // 最高入札者ID
  bidStarterId: string | null;          // 入札開始者ID
  reaperOwnerId: string | null;         // 死神を出したプレイヤーID
  revealedCards: RevealedCard[];        // めくられたカード
  logs: LogEntry[];                     // ゲームログ
  winnerId: string | null;              // 勝者ID
  cardsToReveal: number;                // 残りめくる枚数
  revealingPlayerId: string | null;     // めくっているプレイヤーID
  turnStartStackCounts: Record<string, number>; // 手番開始時の各プレイヤーのスタック枚数
}
```

#### 5.1.2 Player 型定義

```typescript
interface Player {
  id: string;                           // プレイヤーID
  name: string;                         // プレイヤー名
  themeColor: ThemeColor;               // テーマカラー
  hand: Card[];                         // 手札
  stack: Card[];                        // 場のカード
  wins: number;                         // 勝利回数
  isAlive: boolean;                     // 生存状態
  isReady: boolean;                     // 準備完了状態
  hasPassed: boolean;                   // パス済み状態
  eliminatedCardCount: number;         // 除外されたカード数
}
```

#### 5.1.3 Card 型定義

```typescript
interface Card {
  id: string;                           // カードID
  type: CardType;                      // 'angel' | 'reaper'
  isRevealed: boolean;                 // めくられた状態
}
```

#### 5.1.4 GameAction 型定義

```typescript
type GameAction =
  | { type: 'INITIALIZE_GAME'; players: Player[] }
  | { type: 'PLACE_INITIAL_CARD'; playerId: string; cardIndex: number }
  | { type: 'RETURN_INITIAL_CARD'; playerId: string }
  | { type: 'SET_READY'; playerId: string }
  | { type: 'PLACE_CARD'; playerId: string; cardIndex: number }
  | { type: 'RETURN_PLACED_CARD'; playerId: string }
  | { type: 'CONFIRM_PLACEMENT'; playerId: string }
  | { type: 'START_BIDDING'; playerId: string; amount: number }
  | { type: 'RAISE_BID'; playerId: string; amount: number }
  | { type: 'PASS_BID'; playerId: string }
  | { type: 'REVEAL_CARD'; targetPlayerId: string }
  | { type: 'SELECT_PENALTY_CARD'; cardIndex: number }
  | { type: 'SELECT_NEXT_PLAYER'; nextPlayerId: string }
  | { type: 'ADVANCE_PHASE' }
  | { type: 'RESET_GAME' };
```

#### 5.1.5 フェーズ (phase) 一覧

| 値 | 説明 |
|----|------|
| `round_setup` | ラウンド準備中。全プレイヤーが初期カードを場に置き、準備完了ボタンを押すのを待機。 |
| `placement` | 手番フェーズ。カード追加または入札開始を選択。 |
| `bidding` | 入札フェーズ。レイズまたはパスを選択。 |
| `resolution` | 判定フェーズ。最高入札者がカードを1枚ずつめくる。 |
| `penalty` | ペナルティフェーズ。カード除外の選択待ち。 |
| `round_end` | ラウンド終了処理。勝敗判定と次ラウンド準備。 |
| `game_over` | ゲーム終了。勝者が決定。 |

### 5.2 データベースモデル（将来の拡張）

オンラインマルチプレイ機能実装時は、Supabase または Firestore を使用する。

#### 5.2.1 コレクション構造（Supabase/Firestore）

手札情報の秘匿性を担保するため、プレイヤーの手札は別コレクションに分離する。

```
rooms/{roomId}                    # ルーム情報（公開）
rooms/{roomId}/hands/{playerId}   # 各プレイヤーの手札（本人のみ読み取り可）
```

#### 5.2.2 セキュリティルール

- ルーム情報: 参加者なら読み取り可、書き込みはサーバーサイド関数経由
- 手札情報: 本人のみ読み取り可、書き込みはサーバーサイド関数経由

### 5.3 サーバーサイド関数（将来の拡張）

ゲームロジックの整合性を保つため、全ての状態更新はサーバーサイド関数で行う。

```typescript
// 主要なサーバーサイド関数（Supabase Edge Functions または Cloud Functions）
- createRoom(hostId, hostName)           // ルーム作成
- joinRoom(roomId, playerId, playerName) // ルーム参加
- startGame(roomId, hostId)              // ゲーム開始
- placeInitialCard(roomId, playerId, cardIndex)  // 初期カード配置
- setReady(roomId, playerId)                     // 準備完了
- placeCard(roomId, playerId, cardIndex)         // カード追加
- startBidding(roomId, playerId, amount)         // 入札開始
- raiseBid(roomId, playerId, amount)             // レイズ
- passBid(roomId, playerId)                      // パス
- revealCard(roomId, playerId, targetPlayerId)   // カードをめくる
- selectPenaltyCard(roomId, selectingPlayerId, targetCardIndex) // ペナルティカード選択
- selectNextPlayer(roomId, selectingPlayerId, nextPlayerId)     // 次の先手指名
- updateConnectionStatus(roomId, playerId, isConnected)         // 接続状態更新
- transferHost(roomId, newHostId)                               // ホスト移譲
- cleanupInactiveRooms()                                        // 非アクティブルーム削除（定期実行）
```

---

## 6. 広告実装（将来の拡張）

### 6.1 使用サービス
- **Google AdMob** を使用予定。

### 6.2 広告表示タイミング
- **インタースティシャル広告**: ゲーム終了後、「もう一度遊ぶ」ボタン押下時に表示。
- 広告表示後、待機所（Lobby）またはテストモード設定画面に遷移。

### 6.3 実装パッケージ
- React Native 用の AdMob パッケージ（例: `react-native-google-mobile-ads`）を使用予定。

---

## 7. 開発ステップ

### 7.1 実装済み機能

1. **プロジェクトセットアップ**: Expo プロジェクトの作成、TypeScript設定。
2. **状態管理実装**: React Context API + useReducer によるゲーム状態管理。
3. **ゲームロジック実装 (Core)**:
   - ゲームロジック関数の実装（`src/utils/gameLogic.ts`）。
   - フェーズ遷移ロジック。
   - 勝利条件判定。
4. **UI実装**:
   - カードコンポーネント（`src/components/cards/Card.tsx`）。
   - プレイマットコンポーネント（`src/components/game/PlayMat.tsx`）。
   - 手札エリア（`src/components/game/HandArea.tsx`）。
   - 他プレイヤー情報表示（`src/components/game/OtherPlayersInfo.tsx`）。
   - 入札モーダル（`src/components/ui/BidModal.tsx`）。
   - 判定フェーズUI。
   - ゲーム終了画面（`src/screens/ResultScreen.tsx`）。
5. **テストモード実装**:
   - テストモード設定画面（`src/screens/TestModeSetup.tsx`）。
   - プレイヤー切り替え機能。
   - ローカル状態でのゲーム進行。

### 7.2 将来実装予定

1. **インフラ構築**: Supabase または Firebase プロジェクト作成、匿名認証有効化、データベース作成。
2. **サーバーサイド関数実装**: ゲームロジックをサーバーサイドで実装（Supabase Edge Functions または Cloud Functions）。
3. **ルーム機能実装**: 作成、入室、リアルタイム同期。
4. **接続管理実装**:
   - 切断検知、CPU代行、ホスト移譲。
5. **広告実装**:
   - Google AdMob統合。
6. **テストプレイ**:
   - 複数端末でのオンライン動作確認。

---

## 8. テストモード仕様（実装済み）

### 8.1 概要
開発・デバッグ用のテストモードを実装済み。データベース接続なしでローカルでゲームをプレイ可能。

### 8.2 機能要件（実装済み）
- **ローカル実行**: Supabase/Firebaseに接続せず、端末内のみでゲームを完結させる。
- **状態管理**: React Context API + useReducer を使用し、ローカル状態でゲームを管理する。
- **プレイヤー切り替え機能**:
  - テストモードでは、全プレイヤーの操作を1台の端末から行える。
  - **UI**: 画面上部に「プレイヤー切り替え」セレクター（`PlayerSelector`）を配置。
  - **挙動**: 切り替えると、選択したプレイヤー視点のUIに遷移する（手札、プレイマット等が切り替わる）。
  - **手番表示**: 現在の手番プレイヤーを明確に表示し、誰を操作すべきか分かりやすくする。
- **仮想プレイヤー**: 2〜6人の仮想プレイヤーを作成し、それぞれに名前とテーマカラーを割り当てる。

### 8.3 テストモードへのアクセス（実装済み）
- ホーム画面（`HomePage`）に「テストモード」ボタンを配置。
- テストモード設定画面（`TestModeSetup`）でプレイヤー人数を選択（2〜6人）。
- プレイヤー名をカスタマイズ可能。

---

## 9. 補足・未定事項
- **制限時間**:
  - リアル対戦（対面）を前提とするため、画面上にタイマー（例: 30秒）は表示するが、**時間切れによるペナルティ（強制パス等）は設けない**。
  - あくまで目安としてのタイマーとする。
- **サウンド (Audio)**（将来の拡張）:
  - **こだわり**: 臨場感を高めるため、高品質なSE（効果音）を実装する。
  - **実装箇所**: カードを置く音、めくる音、判定成功/失敗のファンファーレ、BGMなど。
  - React Native 用の音声再生パッケージ（例: `expo-av`）を使用予定。

---

## 10. 技術スタック詳細

### 10.1 使用技術（実装済み）

- **フレームワーク**: React Native (Expo SDK 54)
- **言語**: TypeScript
- **状態管理**: React Context API + useReducer
- **ナビゲーション**: React Navigation (Native Stack)
- **アニメーション**: react-native-reanimated
- **UIコンポーネント**: 
  - カスタムコンポーネント（Card, Button, Modal等）
  - expo-linear-gradient（グラデーション背景）
  - react-native-svg（アイコン・装飾）
- **スタイリング**: StyleSheet API

### 10.2 プロジェクト構造

```
src/
├── components/          # UIコンポーネント
│   ├── cards/          # カード関連コンポーネント
│   ├── game/           # ゲーム画面コンポーネント
│   ├── icons/          # アイコンコンポーネント
│   └── ui/             # 汎用UIコンポーネント
├── contexts/           # Context API
│   └── GameContext.tsx # ゲーム状態管理
├── screens/            # 画面コンポーネント
│   ├── HomePage.tsx
│   ├── TestModeSetup.tsx
│   ├── GameScreen.tsx
│   └── ResultScreen.tsx
├── theme/             # テーマ定義
│   ├── colors.ts
│   ├── fonts.ts
│   └── spacing.ts
├── types/             # TypeScript型定義
│   └── game.ts
└── utils/             # ユーティリティ関数
    └── gameLogic.ts
```

### 10.3 将来の拡張性（メモ）

以下の機能は将来対応として検討する。現時点では実装しない。

#### 10.3.1 オンラインマルチプレイ
- Supabase または Firebase を使用したリアルタイム同期
- ルーム作成・入室機能
- サーバーサイド関数によるゲームロジック管理

#### 10.3.2 観戦機能（外部参加）
- 脱落者だけでなく、外部からルームに観戦者として参加できる機能。
- ルーム作成時に「観戦を許可する」オプションを追加。

#### 10.3.3 リプレイ機能
- ゲーム終了後にログから再生できる機能。
- 各アクションのタイムスタンプを元にアニメーション再生。

#### 10.3.4 カスタムルール
- 初期カード枚数の変更（例: 5枚、6枚）。
- 勝利条件の変更（例: 3回成功で勝利）。
- 特殊カードの追加（例: ワイルドカード）。

#### 10.3.5 サウンド実装
- カードを置く音、めくる音、判定成功/失敗のファンファーレ、BGMなど。

---

## 付録A: 状態遷移図

```
[ゲーム開始]
     │
     ▼
┌─────────────────┐
│  round_setup    │◄────────────────────────┐
│ (初期カード配置  │                          │
│  + 準備完了待ち) │                          │
└────────┬────────┘                          │
         │ 全員準備完了                       │
         ▼                                   │
┌─────────────────┐                          │
│   placement     │◄──┐                      │
│  (手番フェーズ)  │    │ カード追加           │
└────────┬────────┘    │                      │
         │             │                      │
         ├─────────────┘                      │
         │ 入札開始                           │
         ▼                                   │
┌─────────────────┐                          │
│    bidding      │◄──┐                      │
│  (入札フェーズ)  │    │ レイズ               │
└────────┬────────┘    │                      │
         │             │                      │
         ├─────────────┘                      │
         │ 全員パス（1人残り）                 │
         ▼                                   │
┌─────────────────┐                          │
│   resolution    │                          │
│  (判定フェーズ)  │                          │
│  ※1枚ずつめくる │                          │
└────────┬────────┘                          │
         │                                   │
         ├──────── 成功 ──────┐               │
         │                   ▼               │
         │          ┌───────────────┐        │
         │          │   round_end   │────────┤
         │          │(ラウンド終了) │        │
         │          └───────┬───────┘        │
         │                  │                │
         │                  │ 勝利条件達成    │
         │                  ▼                │
         │          ┌───────────────┐        │
         │          │   game_over   │        │
         │          │ (ゲーム終了)  │        │
         │          └───────────────┘        │
         │                                   │
         │ 失敗                               │
         ▼                                   │
┌─────────────────┐                          │
│    penalty      │                          │
│(ペナルティフェーズ)│                          │
└────────┬────────┘                          │
         │ カード除外完了                     │
         ▼                                   │
┌─────────────────┐                          │
│   round_end     │──────────────────────────┘
│ (ラウンド終了)   │
└─────────────────┘
```

---

## 付録B: 画面遷移図（実装済み）

```
┌─────────────┐
│   ホーム    │
│   画面      │
│ (HomePage)  │
└──────┬──────┘
       │
       ├─────────────────┬─────────────────┐
       │                 │                 │
       │ (将来実装)      │ (将来実装)      │
       ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ ルーム作成  │   │ ルーム参加  │   │ テストモード │
│   画面      │   │   画面      │   │  設定画面   │
│             │   │             │   │(TestModeSetup)│
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       │ (将来実装)      │ (将来実装)      │
       └────────┬────────┘                 │
                │                          │
       ┌─────────────┐                     │
       │   待機所    │                     │
       │  (Lobby)    │                     │
       │ (将来実装)  │                     │
       └──────┬──────┘                     │
              │ ゲーム開始                  │
              │ (将来実装)                  │
              ▼                            │
       ┌─────────────┐◄────────────────────┘
       │  ゲーム画面  │
       │ (GameScreen)│
       │             │
       └──────┬──────┘
              │ ゲーム終了
              ▼
       ┌─────────────┐
       │ 結果発表画面 │
       │ (勝者発表)   │
       │(ResultScreen)│
       └──────┬──────┘
              │
              ├─── もう一度遊ぶ ───┐
              │    (将来実装:      │
              │     広告表示)      │
              │                   ▼
              │            ┌─────────────┐
              │            │ テストモード │
              │            │  設定画面   │
              │            │(TestModeSetup)│
              │            └─────────────┘
              │
              └─── ホームに戻る ───► ホーム画面
```

### 実装済み画面
- **HomePage**: ホーム画面（ルーム作成・参加・テストモードへの入口）
- **TestModeSetup**: テストモード設定画面（プレイヤー人数・名前設定）
- **GameScreen**: ゲーム画面（メインのゲームプレイ画面）
- **ResultScreen**: 結果発表画面（勝者表示）

### 将来実装予定画面
- **RoomCreate**: ルーム作成画面
- **RoomJoin**: ルーム参加画面
- **Lobby**: 待機所画面（参加者一覧・ゲーム開始）
