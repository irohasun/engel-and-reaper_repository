# オンライン対戦でのカード追加1枚制限修正（v2）

## 問題の分析

### 現状の問題
オンラインモードで、ラウンド準備フェーズ（`round_setup`）において、まだカードが複数枚追加できてしまう。テストモードでは複数枚追加できない。

### 原因の特定

1. **`handlePlaceInitialCard`関数に`canPlaceCard`チェックがない**
   - `src/screens/GameScreen.tsx`の499-510行目
   - `round_setup`フェーズでカードを配置する際、`canPlaceCard`のチェックをしていない
   - `handleSelectCard`関数（552行目）では`canPlaceCard`をチェックしているが、`round_setup`フェーズでは`handlePlaceInitialCard`が使われる

2. **既存の修正の確認**
   - `canPlaceCard`関数：`round_setup`フェーズで既にスタックにカードがある場合は`false`を返す（修正済み）
   - Cloud Functions側：`round_setup`フェーズで既にスタックにカードがある場合はエラーを投げる（修正済み）
   - しかし、クライアント側の`handlePlaceInitialCard`で`canPlaceCard`をチェックしていないため、UI側で制限が効いていない

### テストモードとの比較

**テストモード**:
- `PLACE_INITIAL_CARD`アクションで、既にスタックにカードがある場合は手札に戻してから新しいカードを配置（置き換え）
- しかし、`canPlaceCard`のチェックがないため、UI側で制限されていない可能性もある

**オンラインモード**:
- `PLACE_INITIAL_CARD` → `place_card`アクション（Cloud Functions）
- `handlePlaceInitialCard`で`canPlaceCard`をチェックしていない

## 修正方針

`handlePlaceInitialCard`関数に`canPlaceCard`のチェックを追加し、既にスタックにカードがある場合はカードを配置できないようにする。

### 1. `handlePlaceInitialCard`関数の修正

`src/screens/GameScreen.tsx`の499-510行目を修正：
- `canPlaceCard`のチェックを追加
- 既にスタックにカードがある場合は、カードを配置しない

### 2. テストモードの`PLACE_INITIAL_CARD`アクションの確認

テストモードでも同様の問題がないか確認し、必要に応じて修正する。

## 具体的な修正箇所

### ファイル: `src/screens/GameScreen.tsx`

**修正箇所**: 499-510行目
```typescript
const handlePlaceInitialCard = async () => {
  if (selectedCardIndex === null) return;
  if (state.phase !== 'round_setup') return;
  if (actionLoading) return;
  
  // canPlaceCardのチェックを追加
  if (!canPlaceCard(state, currentViewPlayerId!)) {
    return;
  }
  
  await dispatch({
    type: 'PLACE_INITIAL_CARD',
    playerId: currentViewPlayerId!,
    cardIndex: selectedCardIndex,
  });
  setSelectedCardIndex(null);
};
```

## 期待される動作

1. **ラウンド準備フェーズ**:
   - スタックにカードがない場合のみ、カードを選択して配置可能
   - 既に1枚配置している場合は、追加のカードを配置できない（UI側で無効化）

2. **カード追加フェーズ**:
   - 既存の1枚制限が維持される

## 影響範囲

- `src/screens/GameScreen.tsx`: `handlePlaceInitialCard`関数の修正
- オンラインモードとテストモードの両方に影響（動作の改善）

