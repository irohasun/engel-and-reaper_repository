# オンライン対戦でのカード追加1枚制限修正

## 問題の分析

### 現状の問題
オンライン対戦で、ラウンド準備フェーズ（`round_setup`）において、ルール上1枚しか追加できないはずなのに2枚以上追加できてしまう。

### 原因
1. **クライアント側のチェック不足**: `canPlaceCard`関数で、`round_setup`フェーズでは手札があるかどうかのみをチェックしており、既にスタックにカードがあるかチェックしていない
2. **サーバー側のチェック不足**: Cloud Functions側の`handlePlaceCard`関数で、`round_setup`フェーズでの1枚制限チェックがない

### 現在の実装
- **クライアント側**（`src/utils/gameLogic.ts` 113行目）:
  ```typescript
  if (state.phase === 'round_setup') return player.hand.length > 0;
  ```
  → 既にスタックにカードがある場合でも`true`を返してしまう

- **サーバー側**（`functions/src/game.ts` 115-121行目）:
  - `placement`フェーズでの1枚制限チェックは実装済み
  - `round_setup`フェーズでのチェックがない

## 修正方針

ラウンド準備フェーズでは、各プレイヤーは1枚だけカードを配置できるようにする。

### 1. クライアント側の修正

`src/utils/gameLogic.ts`の`canPlaceCard`関数を修正：
- `round_setup`フェーズで、既にスタックにカードがある場合は`false`を返す

### 2. サーバー側の修正

`functions/src/game.ts`の`handlePlaceCard`関数を修正：
- `round_setup`フェーズで、既にスタックにカードがある場合はエラーを投げる

## 具体的な修正箇所

### ファイル1: `src/utils/gameLogic.ts`

**修正箇所**: 113行目
```typescript
// 修正前
if (state.phase === 'round_setup') return player.hand.length > 0;

// 修正後
if (state.phase === 'round_setup') {
  // 手札がない場合は配置不可
  if (player.hand.length === 0) return false;
  // 既にスタックにカードがある場合は配置不可（1枚制限）
  if (player.stack.length > 0) return false;
  return true;
}
```

### ファイル2: `functions/src/game.ts`

**修正箇所**: 115-121行目の後
```typescript
// placementフェーズの場合、このターンで既にカードを追加していないかチェック
if (gameState.phase === 'placement') {
  const turnStartStackCount = gameState.turnStartStackCounts?.[gameState.players[playerIndex].userId] || 0;
  if (player.stack.length > turnStartStackCount) {
    throw new Error('Already placed a card this turn');
  }
}

// round_setupフェーズの場合、既にスタックにカードがある場合は配置不可（1枚制限）
if (gameState.phase === 'round_setup') {
  if (player.stack.length > 0) {
    throw new Error('Already placed a card in round setup');
  }
}
```

## 期待される動作

1. **ラウンド準備フェーズ**:
   - スタックにカードがない場合のみ、カードを配置可能
   - 既に1枚配置している場合は、追加のカードを配置できない

2. **カード追加フェーズ**:
   - 既存の1枚制限が維持される

## 影響範囲

- `src/utils/gameLogic.ts`: `canPlaceCard`関数の修正
- `functions/src/game.ts`: `handlePlaceCard`関数の修正
- オンラインモードのみに影響（テストモードは変更なし）

